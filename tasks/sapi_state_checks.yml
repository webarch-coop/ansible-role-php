---
- name: Check SAPI state
  block:

    - name: Debug
      debug:
        var: sapi

    - name: "Check that SAPI {{ sapi }} is not set to be present when PHP {{ version }} is set to be removed"
      assert:
        that:
          - sapi.value.state != "present"
      loop:
        - apache2
        - cli
        - fpm
        - phpdbg
      loop_control:
        loop_var: sapi
        label: "{{ sapi.key }}"
      when:
        - php_versions[version].sapis is defined 
        - php_versions[version].sapis.sapi is defined 
        - php_versions[version].sapis.sapi.state is defined 

  tags:
    - php
...
