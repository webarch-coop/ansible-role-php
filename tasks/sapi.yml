---
- name: Configure PHP sapi
  block:

    - name: Debug sapi
      ansible.builtin.debug:
        var: php_sapi.key
        verbosity: 2

    - name: Debug modes enabled
      ansible.builtin.debug:
        var: php_sapi.value.mods_enabled
        verbosity: 2

    - name: Debug existing mods enabled
      ansible.builtin.debug:
        var: ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled
        verbosity: 2

    - name: Include disable module tasks
      ansible.builtin.include_tasks: dismod.yml
      loop: "{{ ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled | difference(php_sapi.value.mods_enabled) }}"
      loop_control:
        loop_var: php_mod
      when: ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled | difference(php_sapi.value.mods_enabled) | length != 0

    - name: Enable module tasks
      block:

        - name: Check that all modules that are due to be enables are available
          ansible.builtin.assert:
            that:
              - php_mod in ansible_local.php.versions[php_version.key].mods_available
            fail_msg: "The PHP {{ php_version.key }} module {{ php_mod }} is not available, check that the php{{ php_version.key }}-{{ php_mod }} package is to be installed."
          loop: "{{ php_sapi.value.mods_enabled | difference(ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled) }}"
          loop_control:
            loop_var: php_mod

        - name: Include enable module tasks
          ansible.builtin.include_tasks: enmod.yml
          loop: "{{ php_sapi.value.mods_enabled | difference(ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled) }}"
          loop_control:
            loop_var: php_mod

      when: php_sapi.value.mods_enabled | difference(ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled) | length != 0

  when: >
    ( ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled | difference(php_sapi.value.mods_enabled) | length != 0 ) or
    ( php_sapi.value.mods_enabled | difference(ansible_local.php.versions[php_version.key].sapis[php_sapi.key].mods_enabled) | length != 0 )
  tags:
    - php
...
