---
- name: PHP SAPI checks
  block:

    - name: Debug PHP version
      debug:
        var: version
        verbosity: 2

    - name: "Debug existing SAPIs for PHP {{ version }}"
      debug:
        var: ansible_local.phpquery.versions[version].sapis
        verbosity: 3
      when: ansible_local.phpquery.versions[version].sapis is defined

    - name: "Set an array for the existing SAPIs for PHP {{ version }}" 
      set_fact:
        php_existing_sapis: "{{ php_existing_sapis | default([]) }} + [ '{{ existing_sapi.key }}' ]"
      when: 
        - ansible_local.phpquery.versions[version].sapis is defined
        - existing_sapi.value.state == "present"
      loop: "{{ ansible_local.phpquery.versions[version].sapis | dict2items }}"
      loop_control:
        loop_var: existing_sapi
        label: "{{ existing_sapi.key }}"

    - name: "Debug existing SAPIs for PHP {{ version }}"
      debug:
        var: php_existing_sapis

    # - name: Generate an array of proposed PHP SAPIs 
    #   set_fact:
    #     php_proposed_sapis: "{{ php_proposed_sapis | default([]) }} + [ '{{ proposed_sapi.key }}' ]"
    #   when: ( proposed_sapi.value.state is defined ) and ( proposed_sapi.value.state == "present" )
    #   loop: "{{ sapis }}"
    #   loop_control:
    #     loop_var: proposed_sapi
    #     label: "{{ proposed_sapi.key }}"

    # - name: Debug proposed PHP SAPIs
    #   debug:
    #     var: php_proposed_sapis
    #   when: php_proposed_sapis is defined

  tags:
    - php
...
